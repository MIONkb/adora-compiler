# Adora : MLIR project for FDRA CGRA SoC
Adora includes two compilers designed for the FDRA CGRA SoC:

- **`cgra-opt`**

-Automated lowering and transformation.

-Performs affine optimizations.

-Generates Data-Flow Graphs (DFG).

-Can be run independently of hardware information.

- **`cgra-mapper`**

-Maps DFG to ADG (Architecture Description Graph).

-Generates RISC-V execution files for the Rocket+CGRA SoC.

#### If you have any issues related to this repository, please don't hesitate to get in touch!

## Directories:
- **`tools`** : Contains the main functions for `cgra-opt` and `cgra-mapper`

- **`include` / `lib`** : C++ headers and source files for `cgra-opt`

- **`mapper`** : C++ source files for `cgra-mapper`

- **`build_tools`** : Bash scripts for building LLVM and Adora

- **`experiment`** : Includes ML benchmarks and C benchmarks (e.g., Polybench). Follow the instructions below to run them. More benchmarks will be added soon.

- **`env.sh`** : Change the environment variables to your own, and source it.
---

# Build

### 1 LLVM-18

LLVM Commit: `26eb4285b56edd8c897642078d91f16ff0fd3472` (Same as Polygeist)

You can download the specified version from the following link:  [LLVM GitHub Repository](https://github.com/llvm/llvm-project/tree/26eb4285b56edd8c897642078d91f16ff0fd3472)

To install LLVM, follow script:  
```bash
./bash_tools/build_llvm.sh
```
### 2 Adora(This project)

Update the LLVM installation path in the following files to your own path:
- `build_cgraopt.sh`
- `CMakeLists.txt`

After making the changes, run `build_cgraopt.sh`.  
**Tip:** It is recommended to execute the script line-by-line (copy-paste using `Ctrl+C`/`Ctrl+V`) for better control.


### 3 Rocket+CGRA SoC

You can download and install the Rocket+CGRA SoC from the appropriate repository:  
[FDRA Repository](https://github.com/MIONkb/FDRA)

### 4 Other Dependencies You May Need

##### For AI Benchmarks: `torch-mlir`

Download and install `torch-mlir`.  
Our supported version is **`torch-mlir_20250127.357`**. (Corresponding torch-vision version: 0.1.6.dev0)

You can find the official repository here:  
[Torch MLIR GitHub Repository](https://github.com/llvm/torch-mlir)

##### For C Benchmarks: Polygeist

Download and install **Polygeist** to run C benchmarks.  
You can find the Polygeist repository here:  
[Polygeist GitHub Repository](https://github.com/llvm/Polygeist)

---

# Run an Example
The `experiment` directory contains pre-transformed MLIR files ready to use.

### Step 1: Set Up Environment Variables
Before running an example, you need to update the environment paths in `env.sh`:

```bash
######################
# Set your own environment paths in env.sh:
# - CGRVOPT_PROJECT_PATH: Path to your `cgra-opt` project (e.g., xxxx/cgra-opt)
# - CGRA_ADG_PATH: Path to the hardware information generated by the Chisel hardware generator
# - CHIPYARD_DIR: Path to Chipyard for final RISC-V compilation and linking
#
# Note:
# - If you only want to generate the DFG and do not need to simulate the benchmark,
#   the CHIPYARD_DIR path is not required.
######################
source env.sh  # Update paths in env.sh as described above.
```
### Step 2: Run 'deriche' example:  C -> mlir -> DFG -> mapping result -> executable file

To run 'deriche' example from Polybench benchmark, you can go with:
```bash
cd experiment/Cbenchmarks/Polybench/medley/deriche/deriche_mini

### From C source file to MLIR. This step can be skipped since the kernel is already in MLIR format.
bash scripts/0_compileCtoMLIR.sh 

### For hardware-independent compilation
bash scripts/1_kernel_opt.sh
bash scripts/2_kernel_dfgs.sh

### For mapping and riscv link (Chipyard must be installed)
bash scripts/3_kernel_map.sh
bash scripts/4_get_all_asms.sh
bash scripts/5_compile_and_link.sh

### The final linked RISC-V executable file can now be simulated using tools such as VCS or Verilator.
```